name: Deploy na Oracle VPS

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente de destino'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - homo
          - prod
      branch:
        description: 'Branch para deploy'
        required: true
        default: 'main'
      docker_command:
        description: 'Comando Docker Compose (ex: up -d --build)'
        required: true
        default: 'up -d --build'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.branch }}

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        echo "Host *" >> ~/.ssh/config
        echo "  StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Escolhe diretÃ³rio por ambiente
      id: diretorio
      run: |
        if [ "${{ github.event.inputs.environment }}" = "prod" ]; then
          echo "dir=/home/${{ secrets.SERVER_USER }}/app-prod" >> "$GITHUB_OUTPUT"
        elif [ "${{ github.event.inputs.environment }}" = "homo" ]; then
          echo "dir=/home/${{ secrets.SERVER_USER }}/app-homo" >> "$GITHUB_OUTPUT"
        else
          echo "dir=/home/${{ secrets.SERVER_USER }}/cbkt-app" >> "$GITHUB_OUTPUT"
        fi

    - name: Deploy via SSH
      run: |
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
          cd ${{ steps.diretorio.outputs.dir }} &&
          git checkout ${{ github.event.inputs.branch }} &&
          git pull &&
          docker compose build &&
          docker compose down &&
          docker compose ${{ github.event.inputs.docker_command }}
        "
